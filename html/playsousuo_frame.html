<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>孔孟之道--播放</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" href="../css/swiper.min.css">
    <style>
        /*#wrap{
         height: 100%;
         background: url(../image/play/play_bg_tra.jpg) no-repeat;
         -webkit-background-size: cover;
         background-size: cover;
         display: -webkit-box;
         display: -webkit-flex;
         display: flex;
         -webkit-box-orient: vertical;
         -webkit-flex-flow: column;
         flex-flow: column;
       }*/
        /*轮播图        */

        .swiper-container {
            width: 100%;
            text-align: center;
            height: 250px;
            line-height: 250px;
        }

        .swiper-container img {
            width: 240px;
            /*margin-top: 50px;*/
        }
        /*nav*/

        nav {
            /*background-color: #fff;*/
        }

        .play-tit {
            font-size: 18px;
            color: #000;
            text-align: center;
            margin: 0 10px;
            padding-left: 10px;
            padding-bottom: 10px;
        }

        .play-poster {
            margin-left: 40px;
            margin-right: 40px;
            text-align: center;
        }

        .play-poster>img {
            width: 100%;
            height: auto;
        }

        .play-txt {
            width: 100%;
            height: 320px;
            margin: 0 auto 20px;
            text-align: center;
            overflow: hidden;
        }

        .play-txt>p {
            color: #b2b2b2;
            font-size: 13px;
            text-align: center;
            line-height: 20px;
        }

        .play-txt>p:nth-of-type(4) {
            color: #000;
            font-size: 15px;
        }

        .play-list {
            width: 100%;
            height: 320px;
            margin: 0 auto 20px;
            text-align: center;
            overflow: hidden;
        }

        .play-list>p {
            color: #000;
            font-size: 14px;
            text-align: left;
            /*padding-left: 50px;*/
            text-align: center;
            line-height: 25px;
        }

        .select {
            display: -webkit-box;
            display: -webkit-flex;
        }

        .select .item-icon {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            text-align: center;
        }

        .select .item-icon>p {
            font-size: 14px;
            color: #999;
        }

        .play-len {
            padding: 10px;
            text-align: center;
        }

        .play-len input {
            width: 75%;
            vertical-align: middle;
        }

        .play-len>span {
            font-size: 14px;
            color: #000;
            line-height: 40px;
            width: 10%;
            text-align: center;
        }

        .length {
            display: inline-block;
            width: 75%;
            position: relative;
        }
        /*banner*/

        banner {
            display: flex;
            display: -webkit-flex;
            display: -webkit-box;
            /*background-color: #fff;*/
            padding-left: 8px;
        }

        banner .item-sort {
            flex: 1;
            -webkit-flex: 1;
            -webkit-box-flex: 1;
            background-position: center;
            background-repeat: no-repeat;
            background-size: contain;
            text-align: center;
            line-height: 108px;
        }
        /*banner .side{
           margin-top: 6px;
         }*/
    </style>
</head>

<body>
    <div id="wrap">
        <nav>
            <div class="play-tit" id="title">
                <!-- 周易 下经 解卦 第四十 -->
            </div>
            <div class="swiper-container">
                <div class="swiper-wrapper">
                    <div class="swiper-slide">
                        <img src="../image/poster.png" alt="">
                    </div>
                    <div class="swiper-slide">
                        <div class="play-txt" id="sousuogeci">

                        </div>
                    </div>
                    <!-- <div class="swiper-slide">
                       <div class="play-list" id="sousuoliebiao">
                           <p>1152 周易上经 乾卦第一.mp3</p>
                       </div>
                   </div> -->
                </div>
            </div>
            <div class="select">
                <div class="item-icon">
                    <img src="../image/play_list.png" alt="" onclick="openRadioList()" id="play-list">
                    <p>播放列表</p>
                </div>
                <div class="item-icon">
                    <img src="../image/play_collect.png" alt="" id="playCollect" onclick="fnOpenPlayCollect();">
                    <p>收藏</p>
                </div>
                <div class="item-icon">
                    <img src="../image/play_share.png" alt="" onclick="fnOpenPlayShare();">
                    <p>分享</p>
                </div>
                <div class="item-icon">
                    <img src="../image/play_discuss.png" alt="" onclick="fnOpenPlayDiscuss();">
                    <p>评论</p>
                </div>
            </div>
            <div class="play-len">
                <span id="kaishijishi">0:00</span>
                <!-- <div class="length"> -->
                <!-- <img src="../image/play_len.png" alt=""> -->
                <input type="range" value="0" name="" id="range">
                <progress max="100" value="0" id="pg"></progress>
                <!-- </div> -->
                <span id="zongshichang"></span>
            </div>
        </nav>
        <banner>
            <div class="item-sort">
                <img src="../image/play_change0.png" alt="" id="img">
            </div>
            <div class="item-sort" id="bfsyq">
                <img src="../image/play_prev.png" onclick="fnOpenPlayershangyi();" alt="">
            </div>
            <div class="item-sort" id="openplayer">
            </div>
            <div class="item-sort">
                <img src="../image/play_next.png" onclick="fnOpenPlayerxiayi();" alt="">
            </div>
            <div class="item-sort side">
                <img src="../image/play_choice.png" alt="" onclick="fnOpenChoicePlayer();">
            </div>
        </banner>
    </div>
    <input type="hidden" id="input" value="">

    <!-- <button onclick="getCurTime()" type="button">获取当前时间点</button>
    <button onclick="setCurTime()" type="button">设置时间位置为5秒</button> -->
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/swiper.min.js"></script>
<script type="text/javascript">
    var id;
    var dqbfid;
    var timer1;
    apiready = function() {
        dqbfid = api.pageParam.a;
        id = api.pageParam.a;
        if(id){
          api.sendEvent({
              name: 'netUrl',
              extra: {
                id: id
              }
          });
        }
        api.addEventListener({
            name: 'dangqianbofang'
        }, function(ret, err) {
            if (ret) {
                dqbfid = ret.value.dangqianbofangid;
                //fnGeCixianshi(dqbfid);
            } else {
                alert(JSON.stringify(err));
            }
        });
        //fnGeCixianshi(id);
        var eHeader = $api.byId('header')
        fnInitSwiper();
        fnOpenChangeImg();
        AddHistory(id);
        fnbofangshijian();
        fnZongShiChang();
        jindutiao();
        var bofang = api.pageParam.bofang;
        if (!bofang) {
            var stylelist = $api.byId('openplayer');
            var html = '';
            html += '<img src="../image/play_now.png" alt="" onclick="fnOpenPlayer();" id="player"></div>';
            $api.html(stylelist, html);
            bofang = 1;
            api.sendEvent({
                name: 'netbofang',
                extra: {
                    bofang: bofang,
                    a: id
                }
            });
            fnNetAudiosPlayByID(id);
        } else if (bofang == 0) {
            var stylelist = $api.byId('openplayer');
            var html = '';
            html += '<img src="../image/play_stop.png" alt="" onclick="fnOpenPlayer();" id="player"></div>';
            $api.html(stylelist, html);
        } else if (bofang == 1) {
            var stylelist = $api.byId('openplayer');
            var html = '';
            html += '<img src="../image/play_now.png" alt="" onclick="fnOpenPlayer();" id="player"></div>';
            $api.html(stylelist, html);
        }

    };
    //播放时间
    function fnbofangshijian(){
      api.addEventListener({
          name: 'bofangshijian'
      }, function(ret, err) {
          if (ret) {
              var stylelist = $api.byId('kaishijishi');
              var html = ret.value.bofangshijian;
              $api.html(stylelist, html);
          }
      });
    }
    //赋值总时长
    function fnZongShiChang() {
      api.addEventListener({
          name: 'zongSC'
      }, function(ret, err) {
          if (ret) {
              var stylelist = $api.byId('zongshichang');
              var html = ret.value.zongSC;
              $api.html(stylelist, html);
          }
      });
    }
    //播放，暂停键
    function fnOpenPlayer() {
        var player = $api.byId('player');
        if (player.getAttribute("src", 2) == "../image/play_stop.png") {
            player.src = "../image/play_now.png";
            fnNetAudiosPlayByID();
            var bofang = 1;
            var a = api.pageParam.a;
            api.sendEvent({
                name: 'netbofang',
                extra: {
                    bofang: bofang,
                    a: a
                }
            });
            var zaicibf
            api.sendEvent({
                name: 'zaicibf',
                extra: {
                    zaicibf: zaicibf,
                }
            });
        } else {
            player.src = "../image/play_stop.png";
            // fnNetAudiosPlayByIDs();
            b();
            var netAudiopausess = '';
            //var  netAudiopausess = ret;
            api.sendEvent({
                name: 'netAudiopause',
                extra: {
                    netAudiopauses: netAudiopausess
                }
            });
            var bofang = 0;
            var a = api.pageParam.a;
            api.sendEvent({
                name: 'netbofang',
                extra: {
                    bofang: bofang,
                    a: a
                }
            });

        }
    }
    function jindutiao(){
      time1 = setInterval(function(e){
          if(pg.value!=100) pg.value++;
           else pg.value=0;
       },200);
      //  api.addEventListener({
      //      name: 'zongJinDu'
      //  }, function(ret, err) {
      //      if (ret) {
      //          var stylelist = $api.byId('zongshichang');
      //          var html = ret.value.zongSC;
      //          //$api.html(stylelist, html);
      //          //fillbar.style.width=""+parseFloat(cur/lenth)*240+"px";
      //      }
      //  });
    }
    // function b(){
    //   clearInterval(time1);
    // }
    //上一曲
    function fnOpenPlayershangyi() {
        var player = $api.byId('player');
        player.src = "../image/play_now.png";
        var c = 1;
        api.sendEvent({
            name: 'bofangshangyi',
            extra: {
              c:c
            }
        });
        // api.getPrefs({
        //     key: 'sousuohistory'
        // }, function(ret, err) {
        //     if (ret) {
        //         var flag = false; //是否增加历史记录
        //         var historyText = ret.value;
        //         var historyArray = historyText.split(',');
        //         for (var i = 0; i < historyArray.length; i++) {
        //             var id1 = historyArray[i];
        //             var id2 = dqbfid;
        //             if (id1 == id2) {
        //                 var ii;
        //                 if (!i) {
        //                     ii = historyArray.length - 1;
        //                 } else if (i == 1) {
        //                     ii = historyArray.length - 1;
        //                 } else {
        //                     ii = i - 1;
        //                 }
        //                 var dangqianbofangid = historyArray.splice(ii, 1);
        //                 api.sendEvent({
        //                     name: 'dangqianbofang',
        //                     extra: {
        //                         dangqianbofangid: dangqianbofangid
        //                     }
        //                 });
        //                 var bofang = 1;
        //                 var a = dangqianbofangid;
        //                 api.sendEvent({
        //                     name: 'netbofang',
        //                     extra: {
        //                         bofang: bofang,
        //                         a: a
        //                     }
        //                 });
        //                 fnNetAudiosPlayByID(dangqianbofangid);
        //             }
        //         }
        //     } else {
        //         alert(JSON.stringify(err));
        //     }
        // });
    }
    //下一曲
    function fnOpenPlayerxiayi() {
      var c = 2;
      api.sendEvent({
          name: 'bofangxiayi',
          extra: {
            c:c
          }
      });
      var player = $api.byId('player');
      player.src = "../image/play_now.png";
        // api.getPrefs({
        //     key: 'sousuohistory'
        // }, function(ret, err) {
        //     if (ret) {
        //         var flag = false; //是否增加历史记录
        //         var historyText = ret.value;
        //         var historyArray = historyText.split(',');
        //         for (var i = 0; i < historyArray.length; i++) {
        //             var id1 = historyArray[i];
        //             var id2 = dqbfid;
        //             if (id1 == id2) {
        //                 var ii;
        //                 var historyArraylength = JSON.stringify(historyArray.length) - 1;
        //                 if (!i) {
        //                     ii = 1;
        //                 } else if (i == historyArraylength) {
        //                     ii = 1;
        //                 } else {
        //                     ii = i + 1;
        //                 }
        //                 var dangqianbofangid = historyArray.splice(ii, 1);
        //                 api.sendEvent({
        //                     name: 'dangqianbofang',
        //                     extra: {
        //                         dangqianbofangid: dangqianbofangid
        //                     }
        //                 });
        //                 var bofang = 1;
        //                 var a = dangqianbofangid;
        //                 api.sendEvent({
        //                     name: 'netbofang',
        //                     extra: {
        //                         bofang: bofang,
        //                         a: a
        //                     }
        //                 });
        //                 fnNetAudiosPlayByID(dangqianbofangid);
        //                 var player = $api.byId('player');
        //                 player.src = "../image/play_now.png";
        //             }
        //         }
        //     } else {
        //         alert(JSON.stringify(err));
        //     }
        // });
    }
    //播放
    function fnNetAudiosPlayByID(id) {
        if (id) {
            api.ajax({
                url: 'http://47.100.11.38/kongmeng/thirdParty/search_songs_by_id.php?id= ' + id,
                method: 'get',
                dataType: 'json',
            }, function(ret, err) {
                if (ret) {
                  var dangqianbofangurl = ret.data[0].url;
                    fnTitlexianshi(ret);
                    fnGeCixianshi(ret);
                    a ();
                    netAudioss = ret;
                    api.sendEvent({
                        name: 'netAudioplay',
                        extra: {
                            netAudios: netAudioss
                        }
                    });
                    var dangqianbofangid = ret.data[0].id;
                    api.sendEvent({
                        name: 'dangqianbofang',
                        extra: {
                            dangqianbofangid: dangqianbofangid
                        }
                    });
                    fnZongShiChang();
                    fnbofangshijian();
                    var title = ret.data[0].name;
                    var singerName = ret.data[0].singerName;
                    AddHistoryTitle(title, singerName);
                } else {
                    alert(JSON.stringify(err));
                }
            });
        } else {
            api.ajax({
                url: 'http://47.100.11.38/kongmeng/thirdParty/search_songs_by_id.php?id= ' + dqbfid,
                method: 'get',
                dataType: 'json',
            }, function(ret, err) {
                if (ret) {
                  var dangqianbofangurl = ret.data[0].url;
                    fnTitlexianshi(ret);
                    fnGeCixianshi(ret);
                    fnZongShiChang(ret);
                    netAudioss = ret;
                    api.sendEvent({
                        name: 'netAudioplay',
                        extra: {
                            netAudios: netAudioss
                        }
                    });
                    var dangqianbofangid = ret.data[0].id;
                    api.sendEvent({
                        name: 'dangqianbofang',
                        extra: {
                            dangqianbofangid: dangqianbofangid
                        }
                    });
                    var title = ret.data[0].name;
                    var singerName = ret.data[0].singerName;
                    AddHistoryTitle(title, singerName);
                } else {
                    alert(JSON.stringify(err));
                }
            });
        }

    }
    //赋值歌词
    function fnGeCixianshi(ret) {
      var stylelist = $api.byId('sousuogeci');
      var html = '<p >' + ret.data[0].desc + '</p>';
      $api.html(stylelist, html);
    }
    var timer2;

    //赋值大标题
    function fnTitlexianshi(ret) {
        var stylelist = $api.byId('title');
        var html = ret.data[0].name;
        $api.html(stylelist, html);
    }

    // 轮播
    function fnInitSwiper() {
        var mySwiper = new Swiper('.swiper-container', {
            loop: false,
        });
    }
    // 选择播放器
    function fnOpenChoicePlayer() {
        api.openWin({
            name: 'choicePlayer',
            url: './choice_player.html',
        });
    };
    // 收藏
    function fnOpenPlayCollect() {
        var playCollect = $api.byId('playCollect');
        if (playCollect.getAttribute("src", 2) == "../image/play_collect.png") {
            playCollect.src = "../image/play_collect0.png";

        } else {
            playCollect.src = "../image/play_collect.png";

        }
    };
    // 打开评论页面
    function fnOpenPlayDiscuss() {
        api.openWin({
            name: 'playDiscuss',
            url: './play_discuss.html',
        })
    }
    //打开分享
    function fnOpenPlayShare() {
        var dialogBox = api.require('dialogBox');
        dialogBox.actionMenu({
            rect: {
                h: 150
            },
            texts: {
                cancel: '取消'
            },
            items: [{
                text: '微信',
                icon: 'widget://image/weixin.png'
            }, {
                text: 'QQ',
                icon: 'widget://image/qq.png'
            }, {
                text: '朋友圈',
                icon: 'widget://image/friends.png'
            }],
            styles: {
                bg: '#FFF',
                column: 3,
                itemText: {
                    color: '#000',
                    size: 12,
                    marginT: 8
                },
                itemIcon: {
                    size: 48
                },
                cancel: {
                    bg: 'fs://icon.png',
                    color: '#000',
                    h: 44,
                    size: 14
                }
            }
        }, function(ret) {
            dialogBox.close({
                dialogName: 'alert'
            })
        });
    }
    //打开播放列表
    function openRadioList() {
        var height = api.frameHeight + 50;
        api.openFrame({
            name: 'playsousuo_radiolist',
            url: './playsousuo_radiolist.html',
            bounces: false,
            bgColor: 'rgba(0,0,0,0.6)',
            rect: {
                x: 0,
                y: 0,
                w: api.frameWidth,
                h: height
            }
        });
    }

    function AddHistory(id) {
        var dangqianbofangid = id;
        api.sendEvent({
            name: 'dangqianbofang',
            extra: {
                dangqianbofangid: dangqianbofangid
            }
        });
        api.getPrefs({
            key: 'sousuohistory'
        }, function(ret, err) {
            if (ret) {
                var flag = false; //是否增加历史记录
                var historyText = ret.value;
                var historyArray = historyText.split(',');
                //console.log(JSON.stringify(historyArray));
                for (var i = 0; i < historyArray.length; i++) {
                    historyArray[i] == id && (flag = true);
                }!flag && historyArray.splice(1, 0, id);
                !flag && api.setPrefs({
                    key: 'sousuohistory',
                    value: historyArray.join(',')
                });
            } else {
                alert(JSON.stringify(err));
            }
        });
    }

    function AddHistoryTitle(title, singerName) {
        api.getPrefs({
            key: 'sousuohistorytitle'
        }, function(ret, err) {
            if (ret) {
                var flag = false; //是否增加历史记录
                var historyText = ret.value;
                var historyArray = historyText.split(',');
                for (var i = 0; i < historyArray.length; i++) {
                    historyArray[i] == title && (flag = true);
                }!flag && historyArray.splice(1, 0, title, singerName);
                !flag && api.setPrefs({
                    key: 'sousuohistorytitle',
                    value: historyArray.join(',')
                });
            } else {
                alert(JSON.stringify(err));
            }
        });
        fnHistorysingerName();
    }

    function fnHistorysingerName() {
        api.getPrefs({
            key: 'sousuohistorytitle'
        }, function(ret, err) {
            var historyText = '' || ret.value;
            var historyArray = historyText.split(',');
            for (var i = 0; i < historyArray.length; i++) {
                if (historyArray[i].length == 0)
                    continue;
                var stylelist = $api.byId('sousuoliebiao');
                var html = '';
                for (var s = 1; s < historyArray.length; s++) {
                    if (historyArray[2 * s - 1]) {
                        //console.log(JSON.stringify(historyArray[2*s-1]));
                        //console.log(JSON.stringify(historyArray[2*s]));
                        html += '<p>' + historyArray[2 * s - 1] + '  ' + historyArray[2 * s] + '</p>';
                    }
                }
                $api.html(stylelist, html);
            }
        });
    }
    // 切换单曲循环、顺序播放、随机播放
    function fnOpenChangeImg() {
        var image_urls = ["../image/play_change0.png", "../image/play_change1.png", "../image/play_change2.png"];
        // 初始化数组键值 (0 = 第一个图片)
        var idx = 0;
        // 点击 id 为 img 的图片
        document.getElementById("img").onclick = function() {
            // idx + 1，如果为最后一张，还原回第一张
            idx = idx === image_urls.length - 1 ? 0 : idx + 1;
            // 设置 src
            this.src = image_urls[idx];
            // 测试
            // alert(this.src);
        };
        // var imgs = document.getElementById('imgBox').getElementsByTagName('img');
        // for(var i=0;i<=imgs.length;i++){
        //   if(i==num+1){
        //      imgs[i].style.display="inline";
        //   }else{
        //     imgs[i].style.display="none";
        //   };
        //   if(num==2){
        //     imgs[0].style.display="inline";
        //   };
        // }
    };
</script>

</html>
