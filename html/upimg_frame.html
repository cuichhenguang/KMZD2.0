<!DOCTYPE HTML>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>孔孟之道--个人信息</title>
	<link rel="stylesheet" type="text/css" href="../css/aui.2.0.css" />
  <link rel="stylesheet" type="text/css"  href="../css/Mdate.css">
	<style>
	#box {
		background: #ffffff;
		height: 106px;
		width: 100%;
		position: fixed;
		left: 0;
		bottom: -106px;
		-webkit-transform: translate3d(0px, -106px, 0px);
		-moz-transform: translate3d(0px, -106px, 0px);
		transform: translate3d(0px, -106px, 0px);
		transition: all 0.3s;
		visibility: hidden;
	}

	#box a {
		display: block;
		width: 100%;
		text-align: center;
		height: 40px;
		background: #fff;
		color: #333;
		line-height: 40px;
		border-bottom: 1px solid #ebebeb;
		font-size: 16px;
		position: relative;
		margin-bottom: 6px;
	}

	.btn {
		margin-top: 0.1rem;
		margin-bottom: 2rem;
		text-align: center
	}

	.btn button {
		width: 90%;
		outline: none;
		border: none;
		background: #009bdb;
		color: #fff;
		height: 40px;
		display: inline-block;
		border-radius: 0.4rem;
		font-size: 16px;
	}

	body {
		background: #ffffff;
		position: relative;
	}

	.aui-pull-left span {
		font-size: 18px;
	}

	.aui-card-list-content {
		width: 130px;
		margin: 0 auto;
		border-radius: 65px;
	}

	.aui-card-list-content img {
		border-radius: 65px;
	}

	.fl {
		float: left;
	}

	.fr {
		float: right;
	}

	.clr {
		clear: both;
	}

	.upimg ul li {
		overflow: hidden;
		padding: 0 10px;
		height: 45px;
		line-height: 45px;
	}

	.upimg ul li div {
		margin: 0 5px;
		font-size: 12px;
	}

	.upimg ul li div:nth-child(1) {
		/*color: #03a9f4;*/
		font-size: 12px;
	}

	.upimg ul li div:nth-child(2) {
		color: #ccc;
	}

	.upimg ul li div:nth-child(3) {
		color: #ccc;
	}

	.upimg_div {
		width: 100%;
		height: 50px;
		line-height: 50px;
		padding: 0 10px;
		font-size: 18px;
		font-weight: 800;
		/*color: #03a9f4;*/
	}

	#header {
		position: fixed;
		left: 0px;
		top: 0px;
		width: 100%;
		height: 45px;
		line-height: 45px;
	}
	#baby .dateSelectorOne{text-align: right;font-size: 12px;line-height: 45px;}
	#babyAdd{border: 2px dashed #ccc; margin: 20px; text-align: center;height: 50px;line-height: 50px;color: #999;font-weight:900;}
	</style>
</head>

<body>
	<!-- 进度条-->
	<div class="aui-progress aui-progress-xxs" style="margin-bottom: 1rem;">
		<div class="aui-progress-bar" id="jd"></div>
	</div>
	<!-- 头像显示区域-->
	<div class="aui-card-list" onclick="upimg()">
		<div class="aui-card-list-content" id="tx" style="">
			<img src="../res/01.jpg" />
		</div>
	</div>
	<div class="upimg">
		<ul>
			<li onclick="fnAlter();">
				<div class="fl">昵称</div>
				<div class="fr"> > </div>
				<div class="fr">最初呢</div>
			</li>
			<li onclick="fnSetGender();">
				<div class="fl">性别</div>
				<div class="fr"> > </div>
				<div class="fr">未填写</div>
			</li>
			<li onclick="fnAlter();">
				<div class="fl">生日</div>
				<div class="fr"> > </div>
				<div class="fr">未填写</div>
			</li>
			<li onclick="fnAlter();">
				<div class="fl">地区</div>
				<div class="fr"> > </div>
				<div class="fr">未填写</div>
			</li>
		</ul>
		<div class="upimg_div">
			<div class="fl">宝宝信息</div>
		</div>
		<div class="upimg_div">
			<div class="fl">宝宝1</div>
		</div>
		<ul id="baby">
			<li onclick="fnSetGender();">
				<div class="fl">性别</div>
				<div class="fr"> > </div>
				<div class="fr">未填写</div>
			</li>
			<li onclick="">
				<div class="fl">生日</div>
				<div class="fr"> > </div>
				<div class="fr"><input type="text" id="dateSelectorOne"	class="dateSelectorOne" placeholder="选择日期"></div>
			</li>

		</ul>
		<div id="babyAdd" onclick="fnBabyAdd()">添加宝宝</div>
	</div>
	<!-- 操作按钮-->
	<div id="box">
		<a>操 作</a>
		<div class="btn" onclick="save()">
			<button>
					截取头像
				</button>
		</div>
	</div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script src="../script/select/iScroll.js"></script>
<script src="../script/select/Mdate.js"></script>
<script type="text/javascript">
	var x = 1;
	function goback() {
		api.closeWin({
			name: 'upimg'
		});
	}
	apiready = function() {
		api.setStatusBarStyle({
			style: 'light',
			color: '#000'
		});
		api.parseTapmode();
		$api.fixStatusBar($api.dom('header'));
		api.addEventListener({
			name: 'keyback'
		}, function(ret, err) {
			goback();
		});
				var periodSelector = api.require('periodSelector');
	};

	function upimg() {
		api.actionSheet({
			title: '上传照片',
			cancelTitle: '取消',
			buttons: ['拍照', '手机相册']
		}, function(ret, err) {
			if (ret) {
				getPicture(ret.buttonIndex);
			}
		});
	}

	function getPicture(sourceType) {
		//相机拍照
		if (sourceType == 1) {
			api.getPicture({
				sourceType: 'camera',
				encodingType: 'jpg',
				mediaValue: 'pic',
				allowEdit: false,
				quality: 96,
				saveToPhotoAlbum: false
			}, function(ret, err) {
				// alert( JSON.stringify( ret ) );
				// alert('1');
				// 获取拍照图像并剪辑
				// if (!ret == '') {
				var data = ret.data
				if (!data == '') {
					$api.byId('box').style.visibility = 'visible';
					var FNImageClip = api.require('FNImageClip');
					FNImageClip.open({
						rect: {
							x: 0,
							y: 0,
							w: api.winWidth,
							h: api.winHeight - document.querySelector('#box').offsetHeight
						},
						srcPath: ret.data,
						mode: 'image',
						style: {
							mask: 'rgba(0,0,0,0.75)',
							clip: {
								w: 200,
								h: 200,
								x: (api.frameWidth - 200) / 2,
								y: (api.frameHeight - 200) / 2,
								borderColor: '#0f0',
								borderWidth: 1,
								appearance: 'rectangle'
							}
						},
					}, function(ret, err) {

					});
				} else {
					// dialogBox.close({
					// 		dialogName: 'alert'
					// });
					// alert('123');
					return;
				}
			});
		} else if (sourceType == 2) {
			//手机相册选图片
			var obj = api.require('UIMediaScanner');
			obj.open({
				type: 'picture',
				column: 4,
				max: 1,
				sort: {
					key: 'time',
					order: 'desc'
				},
				texts: {
					stateText: '已选择*项',
					cancelText: '取消',
					finishText: '完成'
				},
				styles: {
					bg: '#fff',
					mark: {
						icon: '',
						position: 'bottom_right',
						size: 20
					},
					nav: {
						bg: '#eee',
						stateColor: '#000',
						stateSize: 18,
						cancleBg: 'rgba(0,0,0,0)',
						cancelColor: '#000',
						cancelSize: 18,
						finishBg: 'rgba(0,0,0,0)',
						finishColor: '#000',
						finishSize: 18
					}
				}
			}, function(ret) {
				//将选择的图像进行剪辑
				if (ret.eventType == 'cancel') {} else if (ret.list.length > 0) {
					$api.byId('box').style.visibility = 'visible';
					var FNImageClip = api.require('FNImageClip');
					FNImageClip.open({
						rect: {
							x: 0,
							y: 0,
							w: api.winWidth,
							h: api.winHeight - document.querySelector('#box').offsetHeight
						},
						srcPath: ret.list[0].path,
						mode: 'image',
						style: {
							mask: 'rgba(0,0,0,0.75)',
							clip: {
								w: 200,
								h: 200,
								x: (api.frameWidth - 200) / 2,
								y: (api.frameHeight - 200) / 2,
								borderColor: '#0f0',
								borderWidth: 0,
								appearance: 'rectangle'
							}
						},
					}, function(ret, err) {
						alert(JSON.stringify('ret'));
						alert('2')
					});
				}

			});
		}
	}

	//保存剪辑图像
	function save() {
		var FNImageClip = api.require('FNImageClip');
		var nubs = nub(1000, 3000);
		FNImageClip.save({
			destPath: 'fs://tx_' + nubs + '.jpg',
			copyToAlbum: false,
			quality: 1
		}, function(ret, err) {

			$api.byId('box').style.visibility = 'hidden';
			var tx = ret.destPath;
			FNImageClip.close();
			//上传剪辑后的图像到服务器
			api.ajax({
				report: true,
				url: 'http://nfyx.cn/app/up_img.php',
				method: 'post',
				cache: 'false',
				timeout: 30,
				dataTpye: 'json',
				data: {
					files: {
						file: tx
					}
				}
			}, function(ret, err) {
				var b0 = ret.progress;
				$api.byId('jd').style.width = b0 + '%';
				//上传进度
				if (ret.body.ok == 0) {
					api.toast({
						msg: '上传错误',
						duration: 3000,
						location: 'bottom'
					});
				} else if (ret.body.ok == 1) {
					$api.byId('tx').innerHTML = '<img src="http://nfyx.cn/app/img/' + ret.body.name + '">';
					api.toast({
						msg: '上传成功',
						duration: 3000,
						location: 'bottom'
					});
				} else if (ret.body.ok == 2) {
					api.toast({
						msg: '图像无效',
						duration: 3000,
						location: 'bottom'
					});
				}
			});
		});
	}

	function nub(minNum, maxNum) {
		switch (arguments.length) {
			case 1:
				return parseInt(Math.random() * minNum + 1);
				break;
			case 2:
				return parseInt(Math.random() * (maxNum - minNum + 1) + minNum);
				break;
			default:
				return 0;
				break;
		}

	}

	function fnSetGender() {
		api.actionSheet({
			title: '选择性别',
			cancelTitle: '取消',
			buttons: ['男', '女']
		}, function(ret, err) {
			if (ret.buttonIndex >= 3) {
				return;
			}
			var gender = ret.buttonIndex === 1 ? '男' : '女';
			// fnUpdateUserInfo('gender',gender)
		});
	}


	function fnBabyAdd() {
		var id = $api.byId('baby');
		x += 1;
		$api.append(id, '<div class="upimg_div">宝宝' + x + '</div>');
		$api.append(id, '<li onclick="fnSetGender();"><div class="fl">性别</div><div class="fr"> > </div><div class="fr">未填写</div></li>');
		$api.append(id, '<li><div class="fl">年龄</div><div class="fr"> > </div><div class="fr"><input type="text" id="dateSelectorOne'+ x +'"	class="dateSelectorOne"  placeholder="选择日期"></div></li>');
		var dateSelectorOnes = 'dateSelectorOne' + x;
				new Mdate(dateSelectorOnes);

				new Mdate("dateShowBtn", {
				    acceptId: "dateSelectorTwo",
				    beginYear: "2000",
				    beginMonth: "10",
				    beginDay: "24",
				    endYear: "2025",
				    endMonth: "1",
				    endDay: "1",
				    format: "-"
				})
			}
</script>
<script type="text/javascript">
		// var dateSelectorOne = dateSelectorOne + x;
		var dateSelectorOnes = 'dateSelectorOne';
		new Mdate(dateSelectorOnes);

		new Mdate("dateShowBtn", {
		    acceptId: "dateSelectorTwo",
		    beginYear: "2002",
		    beginMonth: "10",
		    beginDay: "24",
		    endYear: "2017",
		    endMonth: "1",
		    endDay: "1",
		    format: "-"
		})
</script>
</html>
