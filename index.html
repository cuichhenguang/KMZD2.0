<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>底部导航</title>
    <link rel="stylesheet" type="text/css" href="./css/api.css" />
    <link rel="stylesheet" type="text/css" href="./css/style.css" />
    <link rel="stylesheet" href="./css/iconfont/iconfont.css">
    <link rel="stylesheet" href="./css/iconfont.css">

    <style>
        .hr01,
        .hr02 {
            height: 28px;
        }
        .headerico {
            padding: 11px 15px 11px 15px;
        }
        .headericohover {
            background: #DADDE0;
        }
        .fr {
            float: right;
        }
        .fl {
            float: left;
        }
        .pa {
            position: absolute;
        }
        img {
            /*vertical-align: top;*/
        }
        header {
            background-color: #89211b;
            padding-top: 10px;
        }
        header ul li {
            display: none;
        }
        header ul li.active {
            display: block;
        }
        .activebar_p20px {
            padding: 0 20px;
        }
        .topbar {
            background: #89211b;
            height: 50px;
            position: relative;
            display: -webkit-box;
            -webkit-box-orient: horizontal;
            text-align: center;
            line-height: 50px;
        }
        .egret-header-box {
            height: 50px;
            background-color: #89211b;
        }
        .egret-img-x {
            text-align: left;
        }
        .egret-img img {
            height: 30px;
            padding: 10px;
        }
        .egret-img-x img {
            width: 25px;
            vertical-align: middle;
        }
        .egret-img-a img {
            width: 25px;
        }
        .egret-img-s {
            text-align: right;
        }
        .egret-img-s img {
            width: 25px;
            height: 25px;
            vertical-align: middle;
        }
        .egret-div {
            -webkit-box-flex: 1;
            color: #fff;
        }
        .egret-header-search {
            background-color: #781711;
            height: 40px;
            margin-top: 8px;
            border-radius: 4px;
            margin: auto;
        }
        .egret-header-search img {
            /*margin-left: 30px;*/
            height: 20px;
            margin-top: 7px;
        }
        .egret-header-search span {
            line-height: 24px;
            width: 150px;
            font-size: 14px;
            padding-top: 8px;
            color: #fff;
            vertical-align: top;
        }
        .egret-header-search input:focus {
            /*border:0;*/
            outline: none;
        }
        .faxian {
            font-size: 18px;
        }
        .friend-tit {
            font-size: 18px;
            color: #fff;
            text-align: center;
            height: 50px;
            line-height: 50px;
        }
        #footer {
            background-color: #fff;
            height: 50px;
            /*padding: 0 10px;*/
        }
        #footer ul li {
            background-position: center;
            background-repeat: no-repeat;
            background-size: contain;
            text-align: center;
            padding-top: 30px;
            background: url() no-repeat center 2px;
            background-size: auto 23px;
            font-size: 11px;
        }
        #footer ul li.active {
            color: #89211b;
        }
        #footer ul li:nth-child(1) {
            background-image: url(./image/footer_sy.png);
        }
        #footer ul li:nth-child(2) {
            background-image: url(./image/footer_fx.png);
        }
        #footer ul li:nth-child(3) {}
        #footer ul li:nth-child(4) {
            background-image: url(./image/footer_gy.png);
        }
        #footer ul li:nth-child(5) {
            background-image: url(./image/footer_wd.png);
        }
        #footer ul li:nth-child(1).active {
            background-image: url(./image/footer_sys.png);
        }
        #footer ul li:nth-child(2).active {
            background-image: url(./image/footer_fxs.png);
        }
        #footer ul li:nth-child(3).active {}
        #footer ul li:nth-child(4).active {
            background-image: url(./image/footer_gys.png);
        }
        #footer ul li:nth-child(5).active {
            background-image: url(./image/footer_wds.png);
        }
        .flex-con {
            /*overflow: auto*/
            overflow: hidden;
        }
    </style>
</head>

<body>
<div id="wrap" class="flex-wrap flex-vertical">
    <header id="secHeader">
        <ul>
            <li class="active">
                <div class="activebar_p20px">
                    <div class="topbar normalHeader">
                        <div class="egret-header-box egret-img-a egret-div " tapmode onclick="openMessage()"><img src="./image/KM_xiaoxi.png" alt=""></div>
                        <div class="egret-header-box egret-div">
                            <div class="egret-header-search">
                                <img src="./image/header_search.png" alt="">
                                <span tapmode onclick="OpenSearch();">请输入关键词搜索</span>
                                <img src="./image/video_header.png" alt="">
                            </div>
                        </div>
                        <div class="egret-header-box egret-img-a egret-div" tapmode onclick="fnDenglu()"><img src="./image/qiandao.png" alt=""></div>
                    </div>
                </div>

            </li>
            <li class="">
                <div class="activebar_p20px">
                    <div class="topbar normalHeader">
                        <div class="egret-header-box egret-img-x egret-div " tapmode onclick="openMessage()"><img src="./image/KM_xiaoxi.png" alt=""></div>
                        <div class="egret-header-box egret-div faxian">
                            发现
                        </div>
                        <div class="egret-header-box egret-img-s egret-div" tapmode onclick="OpenSearch();"><img src="./image/ss.png" alt=""></div>
                    </div>
                </div>
            </li>
            <li class="">开发</li>
            <li class="">
                <div class="friend-tit">
                    国友
                </div>
            </li>
            <li class="">
                <div class="activebar_p20px">
                    <div class="topbar normalHeader"></div>
                </div>
            </li>
        </ul>
    </header>
    <div id="main" class="flex-con">

    </div>
    <div id="footer">
        <ul class="flex-wrap">
            <li tapmode="hover" onclick="randomSwitchBtn( this );" class="flex-con  active">首页</li>
            <li tapmode="hover" onclick="randomSwitchBtn( this );" class="flex-con ">发现</li>
            <li tapmode="hover" onclick="randomSwitchBtn( this );" class="flex-con"></li>
            <li tapmode="hover" onclick="randomSwitchBtn( this );" class="flex-con ">国友</li>
            <li tapmode="hover" onclick="randomSwitchBtn( this );" class="flex-con ">我的</li>
        </ul>
    </div>
</div>
<!-- <div class="centerVideo" id="centerVideo">
    <a class="videoButton"></a>
</div> -->
<div id="yinpin">
    <!-- <audio id="myAudio" >
    </audio> -->
</div>
</body>

</html>
<script type="text/javascript" src="script/api.js"></script>
<script type="text/javascript" src="script/index.js"></script>
<script type="text/javascript">
    var play;
    var timer2;
    var historyUrlArray;
    apiready = function() {
        var secHeader = $api.byId('secHeader');
        $api.fixStatusBar(secHeader);
        var footer = $api.byId('footer');
        var headerH = $api.offset(secHeader).h;
        var footerH = $api.offset(footer).h;
        funIniGroup();
        fnOpenCenterFrame();
        api.parseTapmode();
        initEventListenner();
        // var isFirst = true;
        // fnDenglu();
    }
    function fnOpenCenterFrame() {
        api.openFrame({
            name: 'centerFrame',
            url: './html/center_frame.html',
            rect: {
                x: (api.frameWidth - 70) / 2,
                y: api.frameHeight - 70,
                w: 70,
                h: 70
            },
            pageParam: {
                name: 'test'
            },
            bounces: false,
            bgColor: 'rgba(0,0,0,0)',
            vScrollBarEnabled: false,
            hScrollBarEnabled: false
        });
    }
    //打开消息页面
    function openMessage() {
        api.openWin({
            name: 'message',
            url: './html/message.html',
        });
    };
    // 打开历史页面
    function openHistorys() {
        api.openWin({
            name: 'historys',
            url: './html/historys.html',
        });
    }
    // 打开朗诵页面
    function fnReadWin() {
        api.openWin({
            name: 'read',
            url: './html/read.html',
        });
    }
    // 熏听页面
    function fnListenWin() {
        api.openWin({
            name: 'listen',
            url: './html/listen.html',
        });
    }
    // 底部导航
    function funIniGroup() {
        var qqziliao = api.pageParam.qqziliao;
        var eHeaderLis = $api.domAll('header li'),
            frames = [];
        for (var i = 0, len = eHeaderLis.length; i < len; i++) {
            frames.push({
                name: 'indexFrame' + i,
                url: './html/index_frame' + i + '.html',
                bgColor: 'rgba(0,0,0,.2)',
                pageParam: {
                    name: 'test',
                    qqziliao: qqziliao
                },
                bounces: false
            })
        }
        api.openFrameGroup({
            name: 'group',
            scrollEnabled: false,
            rect: {
                x: 0,
                y: $api.dom('header').offsetHeight,
                w: api.winWidth,
                h: $api.dom('#main').offsetHeight
            },
            index: 0,
            frames: frames
        }, function(ret, err) {
        });
    }
    // 随意切换按钮
    function randomSwitchBtn(tag) {
        if (tag == $api.dom('#footer li.active')) return;
        var eFootLis = $api.domAll('#footer li'),
            eHeaderLis = $api.domAll('header li'),
            index = 0;
        for (var i = 0, len = eFootLis.length; i < len; i++) {
            if (tag == eFootLis[i]) {
                index = i;
            } else {
                $api.removeCls(eFootLis[i], 'active');
                $api.removeCls(eHeaderLis[i], 'active');
            }
        }
        $api.addCls(eFootLis[index], 'active');
        $api.addCls(eHeaderLis[index], 'active');
        api.setFrameGroupIndex({
            name: 'group',
            index: index
        });
    }
    var isFirst = true;
    function fnDenglu() {
        if (isFirst) {
            var dialogBox = api.require('dialogBox');
            dialogBox.alert({
                texts: {
                    content: '签到成功！',
                    leftBtnTitle: '确定'
                    // rightBtnTitle: '去开提醒'
                },
                styles: {
                    bg: '#fff',
                    corner: 6,
                    w: 300,
                    content: {
                        color: '#000',
                        size: 18
                    },
                    left: {
                        marginB: 15,
                        marginL: 30,
                        marginR: 30,
                        w: 240,
                        h: 40,
                        corner: 20,
                        color: "#fff",
                        bg: '#CDCDCD',
                        size: 16
                    }
                },
                tapClose: true
            }, function(ret) {
                if (ret.eventType == 'left') {
                    dialogBox.close({
                        dialogName: 'alert'
                    });
                }
            });
        }
        isFirst = false;
    }
    //音频播放模块
    function netAudios(){
        clearInterval(timer2);
        var myAudio = document.getElementById("myAudio");
        //console.log(myAudio.src);
        myAudio.play();
    }
    //清空所有的计时器
    // function qingkong(){
    // 	//imagePause();
    //   clearInterval(timer2);
    //
    // }
    //将进度条置0
    function reducejindutiao(){
        clearInterval(timer1);
        fillbar.style.width="0";
    }
    //获取当前歌曲的歌长
    function jindutiao(){
        var myAudio = document.getElementById("myAudio");
        timer1=setInterval(function(){
            lenth = myAudio.duration;
            cur=myAudio.currentTime;//获取当前的播放时间
            api.sendEvent({
                name: 'zongJinDu',
                extra: {
                    cur: cur,
                    lenth: lenth,
                }
            });
            //fillbar.style.width=""+parseFloat(cur/lenth)*300+"px";
        },1000)
    }
    //播放音频信息
    function fnBoFangyinpinxinxi(){
        var id = historyUrlArray[play];
        api.ajax({
            url: 'http://47.100.11.38/kongmeng/thirdParty/search_songs_by_id.php?id= ' + id,
            method: 'get',
            dataType: 'json',
        }, function(ret, err) {
            if (ret) {
                fnFuZhiAudio(ret.data[0].url);
                //netUrl(ret.data[0].id);
                //fnTitlexianshi(ret.data[0].name);
                //fnGeCixianshi(ret.data[0].desc);
                //fnZongShiChang(ret.data[0].zongSC);
                var singerName = ret.data[0].singerName;
                //AddHistoryTitle(title, singerName);
            } else {
                alert(JSON.stringify(err));
            }
        });
    }
    //播放时间
    function addtime() {
        var myAudio = document.getElementById("myAudio");
        timer2 = setInterval(function() {
            cur = parseInt(myAudio.currentTime);
            temp=cur;
            minute=parseInt(temp/60);
            if(cur%60<10){
                var html = ""+minute+":0"+cur%60+"";
                //console.log(html);
                api.sendEvent({
                    name: 'bofangshijian',
                    extra: {
                        bofangshijian: html
                    }
                });
            }else{
                var html = ""+minute+":"+cur%60+"";
                //console.log(html);
                api.sendEvent({
                    name: 'bofangshijian',
                    extra: {
                        bofangshijian: html
                    }
                });
            }
        }, 1000);
    }
    //关闭音频
    function netAudiopause (){
        var myAudio = document.getElementById("myAudio");
        myAudio.pause();
    }
    //添加搜索历史id
    function netUrl(id){
        api.getPrefs({
            key: 'sousuohistoryurl'
        }, function(ret, err) {
            if (ret) {
                var flag = false; //是否增加历史记录
                var historyUrlText =  ret.value;
                var historyUrlArray = historyUrlText.split(',');
                for (var i = 0; i < historyUrlArray.length; i++) {
                    historyUrlArray[i] == id && (flag = true);
                }!flag && historyUrlArray.splice(1, 0, id);
                !flag && api.setPrefs({
                    key: 'sousuohistoryurl',
                    value: historyUrlArray.join(',')
                });
                fnHistoryUrl(id);
            } else {
                alert(JSON.stringify(err));
            }
        });
    }
    //循环搜索历史id
    function fnHistoryUrl(id){
        var yinpin = $api.byId('yinpin');
        api.getPrefs({
            key: 'sousuohistoryurl'
        }, function(ret, err) {
            var historyUrlText = '' || ret.value;
            historyUrlArray = historyUrlText.split(',');
            for (var i = 0; i < historyUrlArray.length; i++) {
                if (historyUrlArray[i].length == 0)
                    continue;
                var id1 = historyUrlArray[i];
                var id2 = id;
                var w = i;
                if(id1 == id2){
                    fnAudio(i);
                }
            }
        });
    }
    //audio标签赋值
    function fnFuZhiAudio(url){
        var stylelist = $api.byId('yinpin');
        var html = '<audio id="myAudio" ><source src="' + url + '" type="audio/mpeg"></audio>';
        $api.html(stylelist, html);
        if(html){
            //console.log(html);
            netAudios();
            addtime();
            jindutiao();
        }
    }
    function fnAudio(i){
        play = i;
        fnBoFangyinpinxinxi();
    }
    // function fnsuosuobof(id){
    //   fnHistoryUrl(id)
    // }
    //上一首
    function fnShangYi(){
        var myAudio = document.getElementById("myAudio");
        myAudio.currentTime  = 0;
        netAudiopause();
        clearInterval(timer2);
        play = play-1;
        if(play == 0){
            play = historyUrlArray.length -1;
        }
        fnBoFangyinpinxinxi();
    }
    //下一首
    function fnxiaYi(){
        var myAudio = document.getElementById("myAudio");
        myAudio.currentTime  = 0;
        clearInterval(timer2);
        netAudiopause();
        play = play + 1;
        if(play>historyUrlArray.length-1){
            play=1;
        }
        fnBoFangyinpinxinxi();
    }
    // 初始化事件监听
    function initEventListenner() {
        // 监听城市切换事件（自定义事件）
        // api.addEventListener({
        //     name: 'cityChange'
        // }, function(ret, err) {
        //     if (ret) {
        //         // 打开商品列表等首页的Frames
        //         openFrames();
        //     }
        // });
        //监听url
        api.addEventListener({
            name: 'netUrl'
        }, function(ret, err) {
            if (ret) {
                // api.removePrefs({
                //     key: 'sousuohistoryurl'
                // });
                netUrl(ret.value.id);
            }
        });
        //监听再次播放
        api.addEventListener({
            name: 'zaicibf'
        }, function(ret, err) {
            if (ret) {
                netAudios();
                addtime();
                jindutiao();
            }
        });
        //监听打开音频
        // api.addEventListener({
        //     name: 'netAudioplay'
        // }, function(ret, err) {
        //     if (ret) {
        //         //fnBoFangUrl(ret.value.netAudios.data[0].url);
        //         //fnBoFangUrl(ret.value.netAudios.data[0].url);
        //         // addtime(ret.value.netAudios.data[0].url);
        //         //addtime();
        //     }
        // });
        //监听关闭音频
        api.addEventListener({
            name: 'netAudiopause'
        }, function(ret, err) {
            if (ret) {
                netAudiopause();
            }
        });
        //上一首
        api.addEventListener({
            name: 'bofangshangyi'
        }, function(ret, err) {
            if (ret) {
                fnShangYi();
            }
        });
        //下一首
        api.addEventListener({
            name: 'bofangxiayi'
        }, function(ret, err) {
            if (ret) {
                fnxiaYi();
            }
        });
        // 拦截Android的返回键，在首页点击返回键，提示退出应用
        api.addEventListener({
            name: 'keyback'
        }, function(ret, err) {
            api.confirm({
                title: '提示',
                msg: '是否退出应用',
                buttons: ['确定', '取消']
            }, function(ret, err) {
                if (ret.buttonIndex == 1) {
                    // 关闭当前的主Widget，就可以实现推出APP的效果
                    api.closeWidget({
                        silent: true //直接退出，无需提示
                    });
                }
            });
        });
    }
</script>
