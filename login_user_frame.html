<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>孔孟之道--登录</title>
		<link rel="stylesheet" type="text/css" href="./css/api.css" />
		<link rel="stylesheet" type="text/css" href="./css/style.css" />
		<link rel="stylesheet" href="./css/iconfont/iconfont.css">
		<link rel="stylesheet" href="./css/iconfont.css">
		<style>
			html, body {
				min-height: 100%;
				background: #fff;
			}
			.fr {
				float: right;
			}
			.fl {
				float: left;
			}
			.pa {
				position: absolute;
			}
			.bb {
				border-bottom: 1px solid #e0e0e0;
				height: 1px;
			}
			nav {
				margin: 30px 25px;
			}
			nav .phonenum, .phonepassword {
				width: 100%;
				height: 40px;
				line-height: 40px;
				border: 1px solid #ccc;
				margin-top: 15px;
				border-radius: 5px;
			}
			nav .phonenum > img, .phonepassword > img {
				vertical-align: middle;
			}
			nav .phonenum > input, .phonepassword > input {
				width: 85%;
				height: 36px;
				line-height: 36px;
			}
			nav input:focus, button:focus {
				outline: none;
			}
			nav .loginbutton {
				width: 100%;
				height: 75px;
				line-height: 30px;
				text-align: center;
			}
			.loginbutton button {
				width: 100%;
				height: 40px;
				line-height: 40px;
				text-align: center;
				background-color: #89211b;
				color: #fff;
				margin-top: 15px;
				border-radius: 5px;
			}
			.loginbutton > p {
				text-align: right;
				color: #89211b;
				height: 30px;
				line-height: 30px;
			}
			section {
				margin: 25px;
			}
			section .other {
				width: 100%;
				height: 40px;
				line-height: 40px;
				text-align: center;
			}
			.other > span {
				color: #ccc;
				display: inline-block;
				height: 40px;
				line-height: 40px;
				padding: 0 5px;
			}
			.other .line {
				display: inline-block;
				width: 27%;
				height: 1px;
				background-color: #ccc;
				line-height: 40px;
				vertical-align: middle;
			}
			.otherlogin {
				display: flex;
				display: -webkit-flex;
				display: -webkit-box;
			}
			.otherlogin .login-item {
				flex: 1;
				-webkit-flex: 1;
				-webkit-box-flex: 1;
				text-align: center;
				margin-top: 10px;
			}
		</style>
	</head>
	<body>
		<nav>
			<div class="phonenum">
				<img src="./image/phone.png" alt="">
				<input type="text" placeholder="请输入手机号">
			</div>
			<div class="phonepassword">
				<img src="./image/password.png" alt="">
				<input type="text" placeholder="请输入密码">
			</div>
			<div class="loginbutton">
				<button onclick="fnOpenlogin();">
					登录
				</button>
				<p onclick="fnOpenForgetPassword();">
					忘记密码？
				</p>
			</div>
		</nav>
		<section>
			<div class="other">
				<span class="line"></span>
				<span>其他登录方式</span>
				<span class="line"></span>
			</div>
			<div class="otherlogin ">
				<div class="login-item" onclick="fnWXLogin()" tapmode>
					<img src="./image/weixin.png" alt="">
					<p>
						微信登录
					</p>
				</div>
				<div class="login-item" onclick="fnQQLogin()">
					<img src="./image/qq.png" alt="">
					<p>
						QQ登录
					</p>
				</div>
				<div class="login-item" onclick="fnWBLogin()">
					<img src="./image/weibo.png" alt="">
					<p>
						微博登录
					</p>
				</div>
			</div>
		</section>
	</body>
</html>
<script type="text/javascript" src="script/api.js"></script>
<script type="text/javascript">
	var wx, qq, weibo;
	var userInfos = JSON.stringify($api.getStorage("userInfo"));
	//alert(JSON.stringify($api.getStorage("userInfo")));
	apiready = function() {
		if(userInfos){
			//console.log(JSON.stringify(userInfos));
			api.openWin({
				name : 'index',
				url : './index.html',
				pageParam : {
					name : 'test',
					userInfos : userInfos
				}
			});
		}
		//alert("1");
	}
	// function a() {
	// 	var wx = api.require('wx');
	// 	wx.isInstalled(function(ret, err) {
	// 		if (ret.installed) {
	// 			wx.shareMusic({
	// 			    scene: 'timeline',
	// 			    title: '测试标题',
	// 			    description: '分享内容的描述',
	// 			    thumb: 'widget://a.jpg',
	// 			    contentUrl: 'http://docs.apicloud.com/test/m.mp3'
	// 			}, function(ret, err) {
	// 			    if (ret.status) {
	// 			        alert('分享成功');
	// 			    } else {
	// 			        alert(err.code);
	// 			    }
	// 			});
	// 		} else {
	// 			alert('当前设备未安装微信客户端');
	// 		}
	// 	});
	// }

	var accessToken;
	var openId;
	function fnWXLogin() {
		alert("1");
		var wx = api.require('wx');
		var code;
		wx.isInstalled(function(ret, err) {
			alert("222");
			if (ret.installed) {
				alert(JSON.stringify(ret.installed));
				wx.auth(function(ret, err) {
					console.log(JSON.stringify(ret));
					alert('111');
					if (ret.status) {
						alert('111');
						//alert(JSON.stringify(ret.status));
						//alert(JSON.stringify(ret.code));
						wx.getToken({
							code : ret.code
						}, function(ret, err) {
							if (ret.status) {
								alert(JSON.stringify(ret));
								console.log(JSON.stringify(ret));
								accessToken = ret.accessToken;
								openId = ret.openId;
								wx.getUserInfo({
									accessToken : accessToken,
									openId : openId
								}, function(ret, err) {
									var wxjibenziliao = ret;
									if (ret.status) {
										console.log(JSON.stringify(ret));
										api.openWin({
											name : 'index',
											url : './index.html',
											pageParam : {
												name : 'test',
												wxjibenziliao : wxjibenziliao
											}
										});
										var data = {
												values: {
													openId: openId,
													open_id: ret.openid,
													nick_name: ret.nickname,
													sex: ret.sex,
													avatar: ret.headimgurl,
												}
											};
											$api.setStorage("userInfo", data);
											console.log(JSON.stringify($api.getStorage("userInfo")));
										//alert(JSON.stringify(ret));
										//alert(JSON.stringify(nickname));
									} else {
										alert(err.code);
									}
								});
							} else {
								alert(err.code);
							}
						});
					} else {
						alert(err.code);
					}
				});
			} else {
				alert('当前设备未安装微信客户端');
			}
		});
	}

	function fnQQLogin() {
		var qq = api.require('qq');
		var login = function() {
			qq.login(function(ret, err) {
				var openId = ret.openId;
				var accessToken = ret.accessToken;
				if(ret.status){
				  api.alert({
				      title: '授权成功',
				      msg: '正在打开孔孟知道...',
				  }, function(ret, err){
				      if( ret ){
				           //alert( JSON.stringify( ret ) );
				           qq.getUserInfo(function(ret,err) {
				              if (ret.status) {
				                //console.log(JSON.stringify(ret.info));
				                   //alert(JSON.stringify(ret));
				                 var qqziliao = ret.info;
				                 api.openWin({
				                     name: 'index',
				                     url: './index.html',
				                     pageParam: {
				                         name: 'test',
				                         qqziliao: qqziliao
				                     }
				                 });
				              }else{
				                   alert(JSON.stringify(err));
				              }
				           });
				      }else{
				           alert( JSON.stringify( err ) );
				      }
				  });
				}else {
				    //var toast = new auiToast();
				    // var toast.fail({
				    //     title: "授权失败",
				    //     duration: 1500
				    // });
				}
			});
		};
		qq.installed(function(ret, err) {
			if (ret.status) {
				login();
			} else {
				api.alert({
					msg : "当前设备未安装QQ客户端"
				});
			}
		});
	};
	function fnOpenForgetPassword() {
		api.openWin({
			name : 'forget_password',
			url : './forget_password.html',
			pageParam : {
				name : 'test'
			}
		});
	}

	function fnOpenlogin() {
		api.openWin({
			name : 'index',
			url : './index.html',
			pageParam : {
				name : 'test'
			}
		});
	}

	function fnWBLogin() {
		var weibo = api.require('weibo');
		weibo.auth(function(ret, err) {
			if (ret.status) {
				alert(JSON.stringify(ret));
			}
		});
	}

</script>
